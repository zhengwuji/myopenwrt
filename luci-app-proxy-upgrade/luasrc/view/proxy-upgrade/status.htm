<%+proxy-upgrade /device_info%>

	<div class="cbi-value">
		<label class="cbi-value-title">
			<%:设备详情%>
		</label>
		<div class="cbi-value-field">
			<input type="button" class="cbi-button cbi-button-apply" value="<%:查看选中设备详情%>"
				onclick="viewSelectedDevice()" />
			<div class="cbi-value-description">
				<%:点击此按钮可以查看当前选中设备的详细信息（如MAC地址、连接时间、操作系统等），帮助确认是否选对了设备。%>
			</div>
		</div>
	</div>

	<div class="cbi-value">
		<label class="cbi-value-title">
			<%:测试连接%>
		</label>
		<div class="cbi-value-field">
			<input type="button" class="cbi-button cbi-button-apply" value="<%:测试%>" onclick="testConnection()" />
			<span id="test-result" style="margin-left: 10px;"></span>
			<div class="cbi-value-description">
				<%:点击测试配置的代理是否能正常访问Google。如果显示绿色对勾，说明代理配置正确。%>
			</div>
		</div>
	</div>

	<div class="cbi-value">
		<label class="cbi-value-title">
			<%:开始升级%>
		</label>
		<div class="cbi-value-field">
			<input type="button" class="cbi-button cbi-button-save" value="<%:升级%>" onclick="startUpgrade()" />
			<div class="cbi-value-description">
				<%:确认代理连接正常后，点击此按钮开始执行OpenWrt系统升级脚本。%>
			</div>
		</div>
	</div>

	<script>
		// Helper to extract IP
		function extractIP(val) {
			if (val && typeof val === 'string') {
				var match = val.match(/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/);
				if (match) return match[1];
			}
			return null;
		}

		function viewSelectedDevice() {
			var ip = null;
			var debugMsg = "Debug Log:\n";

			// 1. Try standard LuCI ID pattern
			var el = document.getElementById('cbid.proxy-upgrade.proxy.proxy_ip');
			if (el) {
				debugMsg += "Found standard ID: " + el.value + "\n";
				ip = extractIP(el.value);
			}

			// 2. Try searching by name attribute
			if (!ip) {
				var els = document.getElementsByName('cbid.proxy-upgrade.proxy.proxy_ip');
				if (els.length > 0) {
					debugMsg += "Found by name: " + els[0].value + "\n";
					ip = extractIP(els[0].value);
				}
			}

			// 3. Try searching for any input containing the IP format
			if (!ip) {
				var inputs = document.getElementsByTagName('input');
				for (var i = 0; i < inputs.length; i++) {
					if (inputs[i].type === 'text' || inputs[i].type === 'hidden') {
						var val = inputs[i].value;
						if (val && val.indexOf('.') !== -1 && extractIP(val)) {
							if (inputs[i].id.indexOf('proxy_ip') !== -1 || inputs[i].name.indexOf('proxy_ip') !== -1) {
								debugMsg += "Found heuristic input: " + inputs[i].id + " = " + val + "\n";
								ip = extractIP(val);
								if (ip) break;
							}
						}
					}
				}
			}

			// 4. Try searching for the visible text in Argon's custom dropdown
			if (!ip) {
				var selects = document.querySelectorAll('.cbi-input-select');
				for (var i = 0; i < selects.length; i++) {
					debugMsg += "Found select class: " + selects[i].value + "\n";
					ip = extractIP(selects[i].value);
					if (ip) break;
				}
			}

			if (ip) {
				showDeviceInfo(ip);
			} else {
				var userIp = prompt("自动检测失败。\n\n" + debugMsg + "\n请手动输入IP地址:", "");
				if (userIp) {
					var manualIp = extractIP(userIp);
					if (manualIp) {
						showDeviceInfo(manualIp);
					} else {
						alert("无效的IP地址");
					}
				}
			}
		}

		function showDeviceInfo(ip) {
			var modal = document.getElementById('deviceInfoModal');
			modal.style.display = 'block';

			// Reset fields
			document.getElementById('info-ip').textContent = ip;
			var fields = ['info-mac', 'info-hostname', 'info-connect-time', 'info-connected-duration', 'info-os', 'info-ttl', 'info-connections'];
			for (var i = 0; i < fields.length; i++) {
				document.getElementById(fields[i]).textContent = '加载中...';
			}

			// Fetch device info
			var xhr = new XMLHttpRequest();
			var url = '<%=url("admin/system/proxy-upgrade/device_info")%>?ip=' + encodeURIComponent(ip) + '&t=' + new Date().getTime();

			xhr.open('GET', url, true);
			xhr.timeout = 10000; // 10s timeout

			xhr.onload = function () {
				if (xhr.status === 200) {
					try {
						var data = JSON.parse(xhr.responseText);
						if (data.error) {
							alert("服务器返回错误: " + data.error);
							return;
						}
						document.getElementById('info-mac').textContent = data.mac || '未知';
						document.getElementById('info-hostname').textContent = data.hostname || '未知';
						document.getElementById('info-connect-time').textContent = data.connect_timestamp || '未知';
						document.getElementById('info-connected-duration').textContent = data.connected_time || '未知';
						document.getElementById('info-os').textContent = data.os_type || '未知';
						document.getElementById('info-ttl').textContent = data.ttl || '未知';
						document.getElementById('info-connections').textContent = data.connections || '0';
					} catch (e) {
						console.error("JSON Parse Error:", e);
						console.log("Raw Response:", xhr.responseText);
						document.getElementById('info-mac').textContent = '数据解析失败';
						alert("解析数据失败:\n" + e.message + "\n\n原始数据:\n" + xhr.responseText.substring(0, 100));
					}
				} else {
					document.getElementById('info-mac').textContent = '请求失败 (' + xhr.status + ')';
					alert("请求失败: HTTP " + xhr.status + "\nURL: " + url);
				}
			};

			xhr.onerror = function () {
				document.getElementById('info-mac').textContent = '网络错误';
				alert("网络请求错误 (Network Error)\n请检查网络连接或查看控制台日志。");
			};

			xhr.ontimeout = function () {
				document.getElementById('info-mac').textContent = '请求超时';
				alert("请求超时 (Timeout)");
			};

			xhr.send();
		}

		function closeDeviceInfo() {
			document.getElementById('deviceInfoModal').style.display = 'none';
		}

		// Close modal when clicking outside
		window.onclick = function (event) {
			var modal = document.getElementById('deviceInfoModal');
			if (event.target == modal) {
				modal.style.display = 'none';
			}
		}

		function testConnection() {
			var result = document.getElementById('test-result');
			result.innerHTML = '<span style="color: #0088cc;">测试中...</span>';

			// Helper to get value from input by ID or Name
			function getValue(field) {
				var id = 'cbid.proxy-upgrade.proxy.proxy_' + field;
				var el = document.getElementById(id);
				if (el) return el.value;

				var els = document.getElementsByName(id);
				if (els.length > 0) return els[0].value;

				// Fallback for Argon or other themes that might wrap inputs
				// Try to find input that ends with the field name
				var inputs = document.getElementsByTagName('input');
				for (var i = 0; i < inputs.length; i++) {
					if (inputs[i].name && inputs[i].name.indexOf(field) !== -1) {
						return inputs[i].value;
					}
				}
				// Try select for type
				if (field === 'type') {
					var selects = document.getElementsByTagName('select');
					for (var i = 0; i < selects.length; i++) {
						if (selects[i].name && selects[i].name.indexOf(field) !== -1) {
							return selects[i].value;
						}
					}
				}

				return null;
			}

			var ip = getValue('ip');
			// Extract IP if it contains extra text
			ip = extractIP(ip);

			var port = getValue('port');
			var type = getValue('type');

			// Debug log to console
			console.log("Test Connection Params:", { ip: ip, port: port, type: type });

			var xhr = new XMLHttpRequest();
			xhr.open('POST', '<%=url("admin/system/proxy-upgrade/test")%>', true);
			xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

			xhr.onload = function () {
				if (xhr.status === 200) {
					try {
						var data = JSON.parse(xhr.responseText);
						if (data.success) {
							result.innerHTML = '<span style="color: green;">✓ ' + data.message + '</span>';
						} else {
							result.innerHTML = '<span style="color: red;">✗ ' + data.message + '</span>';
						}
					} catch (e) {
						result.innerHTML = '<span style="color: red;">✗ 数据解析错误</span>';
					}
				} else {
					result.innerHTML = '<span style="color: red;">✗ 请求失败</span>';
				}
			};
			xhr.onerror = function () {
				result.innerHTML = '<span style="color: red;">✗ 网络错误</span>';
			};

			var params = "ip=" + encodeURIComponent(ip || '') +
				"&port=" + encodeURIComponent(port || '') +
				"&type=" + encodeURIComponent(type || 'http');
			xhr.send(params);
		}

		function startUpgrade() {
			if (!confirm('确定要开始升级吗?')) return;

			window.open('<%=url("admin/system/proxy-upgrade/log")%>', '_blank');

			var xhr = new XMLHttpRequest();
			xhr.open('POST', '<%=url("admin/system/proxy-upgrade/upgrade")%>', true);
			xhr.send();
		}
	</script>